<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width" />
    <!-- change title to match the h1 heading -->
    <title>Smart Player API Sample: Midroll Bumper</title>
    <link href="http://files.brightcove.com/proxima-nova/font-faces.css" rel="stylesheet" type="text/css">
    <link href="./css/api-samples.css" rel="stylesheet" type="text/css">
    <link href="./css/midroll-bumper.css" rel="stylesheet" type="text/css">>
  </head>
  <body>
      <div id="main">
        <!-- id of first section is always "top" -->
        <div id="top" class="section">
          <h1><a name="top"></a>Smart Player API Sample: Midroll Bumper</h1>
          <p>This sample plays what looks like a midroll (or postroll) bumper clip. It is not a true bumper, because they are always played preroll. Instead, the "bumpers" here are just other video clips from the media library. Using the buttons above the player, you can choose to play the midroll or postroll bumper, or both.</p>
        </div>
        <!-- every div class section must have an id -->
        <div class="section" id="resources">
          <h2><a name="resources"></a>API resources used</h2>
          <p>This sample uses the following API resources</p>
          <h4>Modules and methods</h4>
          <ul>
            <li>VIDEO_PLAYER
              <ul>
                <li>getCurrentVideo()</li>
                <li>play()</li>
                <li>pause()</li>
                <li>seek()</li>
                <li>addEventListener()</li>
                <li>removeEventListener()</li>
              </ul>
            </li>
          </ul>
          <h4>Events</h4>
          <ul>
            <li>templateLoad</li>
            <li>templateReady</li>
            <li>Media: PROGRESS</li>  
          </ul>
        </div>
        <div class="section" id="player">
          <!-- h2 contents will be in page navigation label - 28 characters (including spaces) maximum -->
          <h2><a name="player"></a>The Player</h2>
          <p>A standard Chromeless Video Player is used for this sample.</p>
          <p class="text-warning">Note that the buttons below are for development purposes only &mdash; do not use in production.</p>
          <div id="modeSwitch">
            <span class="button" onclick="BCL.switchToHTML5()" style="margin-bottom: 20px;margin-right: 10px;">Switch to HTML5 Player</span>
            <span class="button" onclick="BCL.switchToFlash()" style="margin-bottom: 20px;">Switch to Flash Player</span>
          </div>
          <hr/>
          <div id="bumperControls">
            <span id="midroll" class="button">Play Midroll</span>
            <span id="postroll" class="button">Play Postroll</span>
            <span id="both" class="button">Play Both</span>
          </div>
          <div class="player-block">
            <!-- Start of Brightcove Player -->
            <script language="JavaScript" type="text/javascript" src="http://admin.brightcove.com/js/BrightcoveExperiences.js"></script>
            <object id="myExperience921449663001" class="BrightcoveExperience">
              <param name="bgcolor" value="#FFFFFF" />
              <param name="width" value="480" />
              <param name="height" value="270" />
              <param name="playerID" value="2079935931001" />
              <param name="playerKey" value="AQ~~,AAAA1oy1bvE~,ALl2ezBj3WE0z3yX6Xw29sdCvkH5GCJv" />
              <param name="isVid" value="true" />
              <param name="isUI" value="true" />
              <param name="dynamicStreaming" value="true" />
              <param name="@videoPlayer" value="928199562001" />
              <!-- smart player api params -->
              <param name="includeAPI" value="true" />
              <param name="templateLoadHandler" value="BCL.onTemplateLoad" />
              <param name="templateReadyHandler" value="BCL.onTemplateReady" />
            </object>
            <script type="text/javascript">brightcove.createExperiences();</script>
            <!-- End of Brightcove Player -->
          </div>
        </div>
        <div class="section" id="logic">
          <h2><a name="logic"></a>How it is done</h2>
          <p>To play a single mid- or postroll bumper is straightforward. You need a reference to the VIDEO_PLAYER module and to set up a listener for media PROGRESS events &mdash; or you could use a cue point for more precise timing keyed to the main video contents. In the progress event handler, you would wait for the appointed time. Remember that you cannot predict the timing of the events precisely, so you need a comparison check. The PROGRESS event objects include position and duration properties in seconds, which you can use to calculate the mid, quarter, or other points. And you need the ID of the bumber video &mdash; for convenience, store in a video metadata field, so that you can retrieve it using the <code>getCurrentVideo()</code> method.</p>
          <p>When the PROGRESS position is greater than the time to play the bumper, pause the main video, save the position as a restart point, and use <code>loadVideoByID()</code> to play the bumper. One important thing: you need to use <code>removeEventListener()</code> to remove the PROGRESS event listener, or you will loop endlessly through the bumper!</p>
          <p>You also need to set another event listener so that you hear the end of the bumper and know when to reload the main video. You could use the media <code>COMPLETE</code> event, but there is a potential problem. By default, Video Cloud players end playback with an menu screen that shows related videos. The player is still there, but in reduced size. By the time the COMPLETE event fires, the menu will be showing, and so the next video you load will play in the smaller-sized screen. To avoid this, use PROGRESS again &mdash; with a different handler &mdash; and stop the bumper about a half-second before the end. This applies to starting a postroll bumper also.</p>
          <p>After the bumper, you need to reload the main video, and use <code>seek()</code> to get back to the restart position. Remember that <code>seek()</code> will fail silently unless the video is playing. There are different ways to determine this (see the <a href="http://docs.brightcove.com/en/smart-player-api/samples/chaptered-video.html">chaptered video sample</a> for an alterate way), but one of the most reliable is to set another PROGRESS event listener for the main video and place the seeking logic in it. Remember to remove the PROGRESS listener for the bumper when it finishes, and you must also remove the new PROGRESS listener for the main video as soon as you get an event, so that the seek won't be repeated on every event.</p>
          <p>The above generally describes the logic of this sample. The code is slightly more complex, because we decided to allow the possibility of playing a midroll or postroll bumper, or both. the bumper information is stored in a JSON string in the <code>longDescript</code> field:</p>
<pre><code>
{
  "postroll" : 1844554046001,
  "midroll" : 1844554045001
}
</code></pre>
          <p>A bumperType variable is also set to keep track of what kind of bumper should be played, and some conditional logic in the main PROGRESS handler determines at what point to play the bumper and which one to play.</p>
        </div>
        
      </div>
    </div>
    <!-- bcl scripts ============================================================ -->
    <script src="http://docs.brightcove.com/en/scripts/jquery-1.8.3.min.js"></script>
    <script src="http://docs.brightcove.com/en/scripts/handlebars-1.0.rc.2.js"></script>
    <script type="text/javascript">
      /******** Any scripts specific to page samples should go here *********/
      /**** Brightcove Learning namespace ****/
      var BCL = {};
      BCL.bumperType = "midroll";
      BCL.$controlButtons = $("#bumperControls").children();
      /**** template loaded event handler ****/
      BCL.onTemplateLoad = function (experienceID) {
        // get a reference to the player and API Modules and Events
        BCL.player = brightcove.api.getExperience(experienceID);
        BCL.APIModules = brightcove.api.modules.APIModules;
        BCL.mediaEvent = brightcove.api.events.MediaEvent;
      };
      /**** template ready event handler ****/
      BCL.onTemplateReady = function (evt) {
        // get references to modules
        BCL.videoPlayer = BCL.player.getModule(BCL.APIModules.VIDEO_PLAYER);
        // get current video for bumper info
        BCL.videoPlayer.getCurrentVideo( function (videoDTO) {
          // bumper info stored in longDescription as JSON
          BCL.bumpers = JSON.parse(videoDTO.longDescription);
          // save the main video ID
          BCL.mainVideo = videoDTO.id;
          // add PROGRESS listener for main video
          BCL.videoPlayer.addEventListener(BCL.mediaEvent.PROGRESS, BCL.onMainProgress);
        });
        // set click handlers for bumper control buttons
        BCL.$controlButtons.on("click", function(evt) {
          BCL.bumperType = $(this).attr("id");
        });
      };
      /**** main video PROGRESS handler ****/
      BCL.onMainProgress = function (evt) {
        // depends on bumperType
        if (BCL.bumperType == "midroll" || BCL.bumperType == "both") {
          if ((evt.position / evt.duration) > .5) {
            // remove this listener so we don't loop on the bumper
            BCL.videoPlayer.removeEventListener(BCL.mediaEvent.PROGRESS, BCL.onMainProgress);
            // save the position
            BCL.restartPosition = evt.position;
            // pause the video
            BCL.videoPlayer.pause(true);
            // if bumperType is midroll only, set to none
            if (BCL.bumperType == "midroll") {
              BCL.bumperType = "none";
            }
            // add PROGRESS listener for bumper
            BCL.videoPlayer.addEventListener(BCL.mediaEvent.PROGRESS, BCL.onBumperProgress);
            // load the bumper
            BCL.videoPlayer.loadVideoByID(BCL.bumpers.midroll);
          }
        }
        else if (BCL.bumperType == "postroll") {
          if ((evt.duration - evt.position) < .5) {
            // pause the main video
            BCL.videoPlayer.pause(true);
            // set bumperType to none
            BCL.bumperType = "none";
            // remove the listener
            BCL.videoPlayer.removeEventListener(BCL.mediaEvent.PROGRESS, BCL.onMainProgress);
            // just play the postroll and we are done
            BCL.videoPlayer.loadVideoByID(BCL.bumpers.postroll);
          }
        }
      };
     /**** handler for bumper PROGRESS ****/
     BCL.onBumperProgress = function (evt) {
        BCL.log(evt.position);
        if ((evt.duration - evt.position) < .1) {
          // stop the bumper
          BCL.videoPlayer.pause(true);
          // remove this event listener
          BCL.videoPlayer.removeEventListener(BCL.mediaEvent.PROGRESS, BCL.onBumperProgress);
          // add listener for BEGIN that will seek back to the restart point
          BCL.videoPlayer.addEventListener(BCL.mediaEvent.PROGRESS, BCL.seekToRestartPoint);
          // if bumperType is both, set to postroll and reset PROGRESS listener
          if (BCL.bumperType == "both") {
            BCL.bumperType = "postroll";
          };
          // resume the main video
          BCL.videoPlayer.loadVideoByID(BCL.mainVideo);
        };
      };
      /**** function to seek to video restart point ****/
      BCL.seekToRestartPoint = function(evt) {
        // remove this listener
        BCL.videoPlayer.removeEventListener(BCL.mediaEvent.PROGRESS, BCL.seekToRestartPoint);
        // if postroll scheduled, add mainProgress listener
        if (BCL.bumperType == "postroll") {
          BCL.videoPlayer.addEventListener(BCL.mediaEvent.PROGRESS, BCL.onMainProgress);
        }
        // seek to restart point
        BCL.videoPlayer.seek(BCL.restartPosition);
      }
      /*************************
      switch for flash/html
      *************************/
      // for development purposes only: reopen page with HTML5 player
      BCL.switchToHTML5 = function() {
          var separator = "?";
          if (document.location.href.indexOf("?", 0) > -1) {
           separator = "&";
          };
          window.location = document.location.href + separator + "forceHTML=true";
      };
      // for development purposes only: switch back to Flash
      BCL.switchToFlash = function () {
          var startOfQuery = document.location.href.indexOf("forceHTML", 0) -1;
          window.location = document.location.href.substring(0, startOfQuery);
      };
      /*************************
      logging 
      *************************/
      BCL.log = function (message) {
        if (window["console"] && console["log"]) {
          var d = new Date();
          console.log(d + ": ");
          console.log(message);
        };
      };
    </script>
  </body>
</html>
